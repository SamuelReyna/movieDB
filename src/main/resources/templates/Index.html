<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

    <body  layout:fragment="body">

        <!-- Header -->
        <div class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 py-8 border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4">
                <h1 class="text-4xl font-bold text-white text-center mb-2">Películas Populares</h1>
                <p class="text-gray-300 text-center">Las películas más populares del momento</p>

                <!-- Optional: Add a subtle accent line -->
                <div class="w-24 h-1 bg-pink-500 mx-auto mt-4 rounded-full"></div>
            </div>
        </div>

        <!-- Movies Grid -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">

                <!-- Movie Card -->
                <div th:each="movie : ${movies}"
                     class="bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">

                    <!-- Poster Container -->
                    <div class="relative group">
                        <!-- Movie Poster -->
                        <img th:if="${movie.posterPath != null}"
                             th:src="'https://image.tmdb.org/t/p/w500' + ${movie.posterPath}"
                             th:alt="${movie.title}"
                             class="w-full h-80 object-cover">

                        <!-- Placeholder when no poster -->
                        <div th:if="${movie.posterPath == null}"
                             class="w-full h-80 bg-gray-700 flex items-center justify-center">
                            <svg class="w-16 h-16 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>

                        <!-- Heart Checkbox (Superior Izquierda) -->
                        <button class="heart-btn absolute top-2 left-2 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 z-10"
                                th:data-movie-id="${movie.id}"
                                th:classappend="${movie.favorite} ? ' active bg-pink-500 bg-opacity-90 scale-110' : ' bg-black bg-opacity-50 hover:bg-opacity-70'">
                            <svg class="heart-icon w-6 h-6 transition-colors duration-200"
                                 th:attr="fill=${movie.favorite} ? 'currentColor' : 'none'"
                                 th:attrappend="stroke=${movie.favorite} ? '' : 'currentColor'"
                                 th:classappend="${movie.favorite} ? ' text-white' : ' text-white hover:text-pink-500'">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 000-6.364
                                  4.5 4.5 0 00-6.364 0L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                            </path>
                            </svg>
                        </button>



                        <!-- Rating Badge -->
                        <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-yellow-400 px-2 py-1 rounded-full text-sm font-semibold flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            <span th:text="${#numbers.formatDecimal(movie.voteAverage, 1, 1)}">0.0</span>
                        </div>

                        <!-- Hover Overlay -->
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 transition-opacity duration-300 flex items-center justify-center">
                            <button th:attr="data-movie-id=${movie.id}" class="btnIdMovie opacity-0 group-hover:opacity-100 bg-pink-500 hover:bg-pink-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300">
                                Ver Detalles
                            </button>
                        </div>
                    </div>

                    <!-- Movie Info -->
                    <div class="p-4">
                        <!-- Title -->
                        <h3 class="text-white font-semibold text-lg mb-2 line-clamp-2"
                            th:text="${movie.title}">
                            Título de la Película
                        </h3>

                        <!-- Overview -->
                        <p class="text-gray-400 text-sm mb-3 line-clamp-3"
                           th:text="${movie.overview}">
                            Descripción de la película...
                        </p>

                        <!-- Release Date and Vote Count -->
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span class="flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                </svg>
                                <span th:text="${movie.releaseDate != null ? movie.releaseDate.substring(0,4) : 'N/A'}">2024</span>
                            </span>
                            <span class="flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span th:text="${movie.voteCount}">0</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${movies == null or movies.isEmpty()}"
                     class="text-center py-20">
                    <svg class="w-24 h-24 text-gray-600 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                    </svg>                                                                                                                                         
                    <h2 class="text-white text-2xl font-semibold mb-2">No hay películas disponibles</h2>
                    <p class="text-gray-400">Intenta recargar la página</p>
                </div>
            </div>

            <div id="movieModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
                <!-- Background overlay -->
                <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" id="modalOverlay"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                    <!-- Modal panel -->
                    <div class="inline-block w-full max-w-5xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 shadow-xl rounded-2xl border border-gray-700">

                        <!-- Header -->
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-3xl font-bold text-pink-500" id="modalTitle">Cargando...</h3>
                            <button class="text-gray-400 hover:text-white transition-colors" id="closeModal">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Modal content -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Poster y rating -->
                            <div class="md:col-span-1">
                                <img id="modalPoster" src="" alt="Poster" class="w-full rounded-lg shadow-lg mb-4">

                                <!-- Rating -->
                                <div class="mt-2 bg-gray-700 rounded-lg p-4 flex items-center justify-between">
                                    <span class="text-gray-300">Calificación:</span>
                                    <span id="modalRating" class="text-white font-semibold">0.0</span>
                                    <span class="text-gray-400 ml-1">/10</span>
                                </div>

                                <input type="hidden" id="movieId"/>
                                <!-- Add to favorites -->
                                <button class="heart-btn-modal w-full mt-4 bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 000-6.364 4.5 4.5 0 00-6.364 0L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                    Agregar a Favoritos
                                </button>


                            </div>

                            <!-- Detalles de la película -->
                            <div class="md:col-span-2">
                                <div class="mb-4">
                                    <h4 class="text-lg font-semibold text-pink-500 mb-2">Sinopsis</h4>
                                    <p id="modalOverview" class="text-gray-300 leading-relaxed">Cargando descripción...</p>
                                </div>

                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <span class="text-gray-400 text-sm">Fecha de estreno</span>
                                        <p id="modalReleaseDate" class="text-white font-semibold">N/A</p>
                                    </div>
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <span class="text-gray-400 text-sm">Votos</span>
                                        <p id="modalVoteCount" class="text-white font-semibold">0</p>
                                    </div>
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <span class="text-gray-400 text-sm">Idioma</span>
                                        <p id="modalLanguage" class="text-white font-semibold">N/A</p>
                                    </div>
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <span class="text-gray-400 text-sm">Popularidad</span>
                                        <p id="modalPopularity" class="text-white font-semibold">0</p>
                                    </div>
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <span class="text-gray-400 text-sm">Géneros</span>
                                        <p id="modalGenres" class="text-white font-semibold">N/A</p>
                                    </div>
                                    <div class="bg-gray-700 rounded-lg p-4">
                                        <span class="text-gray-400 text-sm">Colección</span>
                                        <p id="modalCollection" class="text-white font-semibold">Ninguna</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Custom CSS for line clamping -->
            <style>
                .line-clamp-2 {
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
                .line-clamp-3 {
                    display: -webkit-box;
                    -webkit-line-clamp: 3;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
            </style>
            <script th:inline="javascript">
                document.querySelectorAll('.heart-btn').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const heartIcon = this.querySelector('.heart-icon');
                        const movieId = this.dataset.movieId;
                        const IdAccount = /*[[${AccountId}]]*/ 0;
                        const sessionId = /*[[${sessionId}]]*/ '';
                        const Token = /*[[${token}]]*/ '';

                        if (this.classList.contains('active')) {
                            this.classList.remove('active', 'bg-pink-500', 'bg-opacity-90', 'scale-110');
                            this.classList.add('bg-black', 'bg-opacity-50');
                            heartIcon.setAttribute('fill', 'none');
                            heartIcon.setAttribute('stroke', 'currentColor');
                            heartIcon.classList.remove('text-white');
                            heartIcon.classList.add('text-white', 'hover:text-pink-500');
                            removeFavorite(movieId, Token, IdAccount);
                        } else {
                            this.classList.add('active', 'bg-pink-500', 'bg-opacity-90', 'scale-110');
                            this.classList.remove('bg-black', 'bg-opacity-50');
                            heartIcon.setAttribute('fill', 'currentColor');
                            heartIcon.removeAttribute('stroke');
                            heartIcon.classList.remove('hover:text-pink-500');
                            heartIcon.classList.add('text-white');
                            addFavorite(movieId, Token, IdAccount);
                        }
                    });
                });


                $(document).on("click", ".btnIdMovie", function () {
                    const IdMovie = $(this).data("movie-id");
                    console.log(IdMovie);
                    $('#movieModal').removeClass('hidden');
                    loadMovieDetails(IdMovie);
                });

                $(document).on("click", ".heart-btn-modal", function () {
                    const heartIcon = this.querySelector('.heart-icon');
                    const IdAccount = /*[[${AccountId}]]*/ 0;
                    const sessionId = /*[[${sessionId}]]*/ '';
                    const Token = /*[[${token}]]*/ '';
                    const movieId = $("#movieId").val();
                            

                    if (this.classList.contains('active')) {
                        removeFavorite(movieId, Token, IdAccount);
                    } else {
                        addFavorite(movieId, Token, IdAccount);
                    }
                });

                function addFavorite(movieId, Token, IdAccount) {
                    // 🔺 Agregar a favoritos


                    $.ajax({
                        url: `https://api.themoviedb.org/3/account/${IdAccount}/favorite`,
                        method: 'POST',
                        contentType: 'application/json;charset=utf-8',
                        dataType: 'json',
                        headers: {"Authorization": `Bearer ${Token}`},
                        data: JSON.stringify({
                            media_type: "movie",
                            media_id: movieId,
                            favorite: true
                        }),
                        success: function (data) {
                            console.log("Agregado a favoritos:", data);
                        },
                        error: function (xhr) {
                            console.error("Error al marcar favorito:", xhr.responseText);
                        }
                    });
                }
                function removeFavorite(movieId, Token, IdAccount) {
                    // 🔻 Quitar de favoritos
                    $.ajax({
                        url: `https://api.themoviedb.org/3/movie/${movieId}?language=es-MX`,
                        method: 'GET',
                        dataType: 'json',
                        headers: {"Authorization": `Bearer ${Token}`},
                        success: function (data) {
                            console.log("Detalle película removida:", data);
                        }
                    });
                    // Aquí harías el DELETE de favoritos (TMDB solo permite update con POST, usando favorite: false)
                    $.ajax({
                        url: `https://api.themoviedb.org/3/account/${IdAccount}/favorite`,
                        method: 'POST',
                        contentType: 'application/json;charset=utf-8',
                        headers: {"Authorization": `Bearer ${Token}`},
                        data: JSON.stringify({
                            media_type: "movie",
                            media_id: movieId,
                            favorite: false
                        }),
                        success: function (data) {
                            console.log("Eliminado de favoritos:", data);
                        },
                        error: function (xhr) {
                            console.error("Error al eliminar:", xhr.responseText);
                        }
                    });
                }
                function loadMovieDetails(IdMovie) {
                    const Token = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwOTg2ZmY4NzM0Y2YyMDI4NWFkNzBiNjJlODZmYzY0NSIsIm5iZiI6MTc1NzcwMzIyNC45NTcsInN1YiI6IjY4YzQ2YzM4YTlmYjViODI3NjhkNzNjYiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.H8LWQFVeOAKNZZ00HhZCIYChFfrsT3_paRZZpevGlu8";
                    $.ajax({
                        url: `https://api.themoviedb.org/3/movie/${IdMovie}?language=es-MX`,
                        method: 'GET',
                        dataType: 'json',
                        headers: {"Authorization": `Bearer ${Token}`},
                        success: function (data) {
                            const posterBase = "https://image.tmdb.org/t/p/w500";
                            $('#movieId').val(data.id);
                            $('#modalTitle').text(data.title);
                            $('#modalOverview').text(data.overview || 'Sin descripción disponible');
                            $('#modalPoster').attr('src', data.poster_path ? posterBase + data.poster_path : '/default-poster.png');
                            $('#modalRating').text(data.vote_average.toFixed(1));
                            $('#modalReleaseDate').text(data.release_date || 'N/A');
                            $('#modalVoteCount').text(data.vote_count.toLocaleString());
                            $('#modalLanguage').text(data.original_language.toUpperCase());
                            $('#modalPopularity').text(data.popularity.toFixed(1));
                            $('#modalGenres').text(data.genres ? data.genres.map(g => g.name).join(', ') : 'N/A');
                            $('#modalCollection').text(data.belongs_to_collection ? data.belongs_to_collection.name : 'Ninguna');
                            if (data.homepage) {
                                $('#modalHomepage').attr('href', data.homepage).removeClass('hidden');
                            } else {
                                $('#modalHomepage').addClass('hidden');
                            }

                            // Abrir modal
                            $('#movieModal').removeClass('hidden');
                        },
                        error: function (xhr, status, error) {
                            console.error('Error al cargar los detalles:', error);
                            $('#modalTitle').text('Error');
                            $('#modalOverview').text('No se pudieron cargar los detalles.');
                        }
                    });
                    $('#closeModal, #modalOverlay').click(function () {
                        $('#movieModal').addClass('hidden');
                    });
                }
            </script>
    </body>
</html>
